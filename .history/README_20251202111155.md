# Android Targets plugin

> **Warning**
> 
> This is highly experimental and not part of any official Expo workflow.

[![npm version](https://img.shields.io/npm/v/expo-android-targets.svg)](https://www.npmjs.com/package/expo-android-targets)
[![CI](https://github.com/franciskouaho/expo-android-targets/actions/workflows/ci.yml/badge.svg)](https://github.com/franciskouaho/expo-android-targets/actions/workflows/ci.yml)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Downloads](https://img.shields.io/npm/dm/expo-android-targets.svg)](https://www.npmjs.com/package/expo-android-targets)

An experimental Expo Config Plugin that generates native Android targets like Home Screen Widgets using Jetpack Glance, and links them outside the `/android` directory. You can open Android Studio and develop the targets inside the virtual `expo:targets` folder and the changes will be saved outside of the `android` directory. This pattern enables building things that fall outside of the scope of React Native while still obtaining all the benefits of Continuous Native Generation.

## ğŸš€ How to use

> This plugin requires at least Expo SDK 49+, Android minSdkVersion 21+, and React Native 0.70+.

1. Run `npm install expo-android-targets` in your Expo project.
2. Add the plugin to your `app.config.js`:

```javascript
module.exports = {
  name: "My App",
  slug: "my-app",
  android: {
    package: "com.company.myapp",
  },
  plugins: [
    "expo-android-targets"
  ],
};
```

3. Run `npx expo prebuild -p android --clean` to generate the Android project.
4. You can now open your project in Android Studio and develop the widget.
5. When you're ready to build, select the target and build it.

## Usage Examples

### Update on App Launch

```typescript
import { useEffect } from 'react';
import { updateWidgetData } from 'expo-android-targets';

export default function App() {
  useEffect(() => {
    updateWidgetData('Welcome', 'App is ready!');
  }, []);

  return <YourApp />;
}
```

### Update on State Change

```typescript
import { useState } from 'react';
import { updateWidgetData } from 'expo-android-targets';

function GameSelector() {
  const [selectedGame, setSelectedGame] = useState('');

  const selectGame = (game: string) => {
    setSelectedGame(game);
    updateWidgetData('Nightly', `Next game: ${game}`);
  };

  return (
    <View>
      <Button title="Truth or Dare" onPress={() => selectGame('Truth or Dare')} />
      <Button title="Never Have I Ever" onPress={() => selectGame('Never Have I Ever')} />
    </View>
  );
}
```

### Update from API Response

```typescript
import { updateWidgetData } from 'expo-android-targets';

async function fetchAndUpdateWidget() {
  const response = await fetch('https://api.example.com/status');
  const data = await response.json();

  updateWidgetData(data.title, data.subtitle);
}
```

## Customization

### Change Widget Colors

The plugin copies template files to your project. After running `expo prebuild`, you can customize:

**android/app/src/main/java/[your-package]/widget/NightlyGlanceWidget.kt:**

```kotlin
// Background color
.background(ColorProvider(android.graphics.Color.parseColor("#1a1a2e")))

// Title color
color = ColorProvider(android.graphics.Color.WHITE),

// Subtitle color
color = ColorProvider(android.graphics.Color.parseColor("#b0b0b0")),
```

### Change Widget Size

**android/app/src/main/res/xml/nightly_widget_info.xml:**

```xml
<appwidget-provider
    android:minWidth="180dp"
    android:minHeight="60dp"
    android:resizeMode="horizontal|vertical" />
```

### Add More Fields

1. Update `WidgetPreferences.kt` to add new SharedPreferences keys
2. Update `WidgetModule.kt` to accept new parameters
3. Update `NightlyGlanceWidget.kt` to display new fields
4. Update TypeScript types in your app

See [Advanced Customization Guide](./ADVANCED.md) for detailed examples.

## How it works

The root `/templates` folder contains the target files that get copied to your project. When you run `npx expo prebuild --clean`, the plugin will:

1. **Add Gradle Dependencies** - Injects Jetpack Glance and AndroidX libraries into `build.gradle`
2. **Copy Kotlin Files** - Installs widget implementation, receiver, and React Native module
3. **Copy XML Resources** - Adds widget provider config and placeholder layout
4. **Update AndroidManifest** - Registers the widget receiver with intent filters
5. **Register Native Module** - Adds `WidgetPackage` to your `MainApplication`

The Config Plugin will link the template files to Android Studio, and all files inside of the generated Android project will be part of the target. This means you can develop the target and the changes will be saved in the generated `android` directory.

Any files in the `templates` directory are managed and can be freely modified after prebuild in the generated `android` directory.

## Development

Any changes you make outside of the `templates` directory in Android Studio are subject to being overwritten by the next `npx expo prebuild --clean`. Check to see if the settings you want to toggle are available in the template files or the plugin configuration. If you modify the plugin or your root `app.json`, you will need to re-run `npx expo prebuild --clean` to sync the changes.

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   React Native      â”‚
â”‚   updateWidgetData()â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WidgetModule      â”‚
â”‚   (Native Module)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WidgetPreferences   â”‚
â”‚ (SharedPreferences) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NightlyGlanceWidget â”‚
â”‚ (Glance Composable) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Home Screen UI    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Requirements

- Expo SDK 49+
- Android minSdkVersion 21+
- React Native 0.70+
- Android Studio (for development)

## TypeScript

Fully typed out of the box:

```typescript
import { updateWidgetData } from 'expo-android-targets';

// Type signature
updateWidgetData(title: string, subtitle: string): void
```

## Sharing data between targets

To share values between the app and the widget, we use SharedPreferences and a native module bridge. The plugin automatically sets up a React Native module (`WidgetModule`) that allows you to update widget data from JavaScript.

### Setting shared data

To define shared data, we use a native module (`WidgetModule`) that interacts with SharedPreferences.

Somewhere in your Expo app, you can set widget data:

```typescript
import { updateWidgetData } from "expo-android-targets";

// Update widget with title and subtitle
updateWidgetData("Nightly", "Next game: Truth or Dare");

// Or with dynamic data
const response = await fetch('https://api.example.com/status');
const data = await response.json();
updateWidgetData(data.title, data.subtitle);
```

The `updateWidgetData` function:
- Writes data to SharedPreferences with keys `widget_title` and `widget_subtitle`
- Triggers a widget update via `AppWidgetManager.updateAppWidget()`
- Works seamlessly from any React Native component

### Accessing shared data

The widget accesses data directly from SharedPreferences in Kotlin. The template files include `WidgetPreferences.kt` which handles reading the stored values:

```kotlin
val preferences = context.getSharedPreferences("widget_prefs", Context.MODE_PRIVATE)
val title = preferences.getString("widget_title", "Default Title")
val subtitle = preferences.getString("widget_subtitle", "Default Subtitle")
```

The widget automatically reads these values when it updates and displays them in the Glance UI.

## Troubleshooting

### Widget Not Appearing

Run clean prebuild:
```bash
rm -rf android
npx expo prebuild --platform android --clean
npx expo run:android
```

### Widget Not Updating

Check native logs:
```bash
adb logcat | grep -i widget
```

Verify module registration:
```bash
cat android/app/src/main/java/*/MainApplication.* | grep WidgetPackage
```

### Build Errors

Ensure your Android package name matches across:
- `app.config.js` â†’ `android.package`
- Generated Kotlin files
- AndroidManifest.xml

## Widget Configuration

The plugin auto-detects your package name from `app.config.js`. The widget files are automatically placed in the correct package structure based on your `android.package` configuration.

### Custom Package Name

If you need to customize paths, you can configure the plugin:

```javascript
plugins: [
  [
    "expo-android-targets",
    {
      androidPackage: "com.custom.package"
    }
  ]
]
```

### Widget Provider Settings

After prebuild, you can customize the widget provider settings in:

**android/app/src/main/res/xml/nightly_widget_info.xml:**

```xml
<appwidget-provider
    android:minWidth="180dp"
    android:minHeight="60dp"
    android:resizeMode="horizontal|vertical"
    android:updatePeriodMillis="1800000"
    android:previewLayout="@layout/appwidget_placeholder" />
```

## Building Widgets

If you experience issues building widgets, it might be because React Native compilation complexity. Some workarounds:

- Clear the build cache: `cd android && ./gradlew clean`
- Clean prebuild: `rm -rf android && npx expo prebuild -p android --clean`
- Verify Gradle dependencies are correctly added in `build.gradle`

### Adding Widget to Home Screen

1. Build and install your app on an Android device or emulator
2. Long-press on Android home screen
3. Tap "Widgets"
4. Find your app's widget (it will appear with your app name)
5. Drag to home screen
6. The widget will display data updated from your React Native app

## Code Signing

The code signing is handled entirely by your Android build configuration and signing keys. The plugin automatically adds the necessary permissions and receiver declarations to the AndroidManifest.

## Contributing

Contributions are welcome! Please:

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable
5. Submit a pull request

## About

Config Plugin to setup Android targets

### Resources

- [Full Documentation](./WIDGET_SETUP.md)
- [Quick Start Guide](./QUICK_START.md)
- [Report Issues](https://github.com/franciskouaho/expo-android-targets/issues)

### Related

- [Expo Config Plugins](https://docs.expo.dev/guides/config-plugins/)
- [Jetpack Glance](https://developer.android.com/jetpack/compose/glance)
- [Android App Widgets](https://developer.android.com/guide/topics/appwidgets/overview)
